---
title: "crypto"
author: "Alex"
date: "5/27/2021"
output: html_document
---

NOTE: THIS DOES NOT CONSTITUTE INVESTMENT ADVICE
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(zoo)
library(lubridate)
coins = read_csv('/Users/APinkerton/NYC_DS_A/R-direc/R/R/aggreg_coins.csv')
head(coins)
coins = na.omit(coins)
coins$date_time = as.Date(coins$Date)
coins$weekday = weekdays.Date(coins$date_time)
require(Hmisc)
coins$d_i_m=monthDays(as.Date(coins$date_time))
coins %>% group_by(Name, date_time) %>% summarise (open = Open, close = Close)
post = filter(coins, date_time>'2015-12-31')
post$day_in_mo = substr(post$date_time,9,10)
post$perc_in_mo_bod = (as.numeric(post$day_in_mo )-1) / as.numeric(post$d_i_m )
post
post$perc_in_mo_eod = as.numeric(post$day_in_mo)  / as.numeric(post$d_i_m)
post

#rollmean{zoo}
```
```{r}
cal <- read_csv('./calendar.csv')
cal$date = as.Date(cal$date)
cal
```



```{r}
wip <- post
library(scales)
wip$day_ret = (wip$Open / wip$Close)-1

wip$date_time
cal$date

full_df <- merge(wip,cal,by.x='date_time',by.y='date')
full_df %>% ungroup %>% arrange(desc('date_time'),'Symbol')
sorted_df = arrange(full_df, Symbol, date_time ,by_group=F)
sorted_df
sorted_df$mo_yr = paste0(substr(sorted_df$date_time,6,7),"-",substr(sorted_df$date_time,1,4))
sorted_df
weekly_norm = group_by(sorted_df, Name, wk_num) %>% summarise(norm_wk_ret_mean=mean(day_ret),norm_wk_ret_sd=sd(day_ret))
weekly_norm
```

```{r}
sorted_df
monthly_norm = group_by(sorted_df, Name, mo_yr) %>% summarise(norm_mo_ret_mean=mean(day_ret),norm_mo_ret_sd=sd(day_ret))
monthly_norm

```
```{r}
sorted_df$yr = substr(sorted_df$date_time,1,4)
sorted_df$mo = substr(sorted_df$date_time,6,7)
sorted_df$qtr_yr = paste(ifelse(sorted_df$mo %in% c(1,2,3), 1, ifelse(sorted_df$mo %in% c(4,5,6), 2,ifelse(sorted_df$mo %in% c(7,8,9), 3,4))),'-',sorted_df$yr)


sorted_df
yearly_norm = group_by(sorted_df, Name, yr) %>% summarise(norm_yr_ret_mean=mean(day_ret),norm_yr_ret_sd=sd(day_ret))
yearly_norm

qtrly_norm = group_by(sorted_df, Name, qtr_yr) %>% summarise(norm_qtr_ret_mean=mean(day_ret),norm_qtr_ret_sd=sd(day_ret))
qtrly_norm

```
```{r}
all_cols = sorted_df
all_cols

weekly_norm
sorted_df = left_join(sorted_df, weekly_norm, by=c('Name' = 'Name', 'wk_num' = 'wk_num'))
wk

monthly_norm
sorted_df = left_join(sorted_df, monthly_norm, by=c('Name' = 'Name', 'mo_yr' = 'mo_yr'))
mo

qtrly_norm
sorted_df = left_join(sorted_df,qtrly_norm, by = c('Name' ='Name' , 'qtr_yr' = 'qtr_yr'))

yearly_norm
sorted_df = left_join(sorted_df,yearly_norm, by = c('Name' ='Name' , 'yr' = 'yr'))

sorted_df = sorted_df %>% rename(wk_ret_mean = norm_wk_ret_mean, wk_ret_sd = norm_wk_ret_sd, mo_ret_mean = norm_mo_ret_mean, mo_ret_sd = norm_mo_ret_sd, qtr_ret_mean = norm_qtr_ret_mean, qtr_ret_sd = norm_qtr_ret_sd, yr_ret_mean = norm_yr_ret_mean, yr_ret_sd = norm_yr_ret_sd)

sorted_df

#weekly_returns_normalized = ( returns - avg_ret_per_wk ) / norm_wk_ret_sd

```
```{r}
#Normalizing daily returns to the week, month, quarter, and year

norm_df = sorted_df
norm_df$day_ret_norm_to_wk = ((norm_df$day_ret - norm_df$wk_ret_mean) / norm_df$wk_ret_sd)
norm_df$day_ret_norm_to_mo = ((norm_df$day_ret - norm_df$mo_ret_mean) / norm_df$mo_ret_sd)
norm_df$day_ret_norm_to_qtr = ((norm_df$day_ret - norm_df$qtr_ret_mean) / norm_df$qtr_ret_sd)
norm_df$day_ret_norm_to_yr = ((norm_df$day_ret - norm_df$yr_ret_mean) / norm_df$yr_ret_sd)
norm_df
```
```{r}

norm_df
norm_day_tbl = norm_df %>% group_by(Symbol, wk_day_n) %>% summarise(norm_day=mean(day_ret_norm_to_wk))
norm_day_tbl
library(reshape2)
melted = melt(norm_day_tbl,id.vars=c('wk_day_n','Symbol') ,measure.vars='norm_day')
melted
all_symbols_daily <- ggplot(melted, aes(x=wk_day_n, y=value, col=Symbol)) + geom_line()
all_symbols_daily
melted %>% group_by(Symbol) %>% top_n(1,value)

norm_day_tbl %>% group_by(wk_day_n) %>% summarise(mean(norm_day, na.rm=T))

```
